<script>
  $(set_back())
</script>

<%= provide :title, @job.name %>

<% if @job.status != 'release' && @job.status != 'end' %>
<%= provide :content, '编辑' %>
<%= provide :link, edit_employer_job_path(params[:id]) %>
<% end %>
<div id="job_show">
  <% if @job.operate_at && (@job.status == 'release' || @job.status == 'pause') %>
    <div class="job-time">
      发布日期:
      <span><%= @job.operate_at.strftime("%Y-%m-%d") %></span>
      (剩余<%= @time_left %>天到期)
    </div>
  <% end %>

  <section class="job-detail">
    <div class="job-introduce">
      <h3><%= @job.name %><span><%= @seeker_count %>人投递过简历</span></h3>
      <p class="job-range"><%= @job.salary_range %>/月</p>
      <ul>
        <li><span>医院     </span><%= @hospital.name %></li>
        <li><span>性质     </span><%= @hospital.property %><p><span class="job-scale">规模</span><%= @hospital.scale %></p></li>
        <li><span>地区     </span><%= @job.region %><p><span class="job-number">人数</span><%= @job.needed_number %>人</p></li>
        <li><span>经验要求</span>   <%= @job.experience %></li>
      </ul>
    </div>
    <div class="job-place"><a href="http://api.map.baidu.com/marker?location=<%= @hospital.lat %>,<%= @hospital.lng %>&title=<%= @hospital.name %>&content=<%= @job.location %>&output=html"><span>工作地点</span><%= @job.location %><%= image_tag "jobright.png" %></a></div>

    <!-- 刷新简历 -->
    <% if @job.status == "release" %>
      <button class="reflesh-job">
        <div class="">
          <%= image_tag "icon_1.png" %>
          <span>刷新职位</span>
        </div>
      </button>
      <button class="reflesh-job reflesh-time"><%= @left_refresh_time %>天后再次刷新</button>
      <script type="text/javascript">
          //  reflesh_time 值不同显示不同
          var reflesh_time = "<%= @left_refresh_time %>";
          if(reflesh_time == -1) {
            $('.reflesh-job').css('display','block').siblings('.reflesh-time')
                                                    .css('display','none');
          }else{
            $('.reflesh-time').css('display','block').siblings('.reflesh-job')
                                                     .css('display','none');
          }
      </script>
    <% end %>
  </section>


  <script type="text/javascript">
    $('.reflesh-job').bind('click',function(){
      $.ajax({
        url: "<%= api_employer_jobs_path %>",
        type: "PATCH",
        data: {refresh_at: "<%= @job.refresh_at %>",
               job_id: "<%= @job.id %>"
             },
        success: function(){
          $('.reflesh-time').html('7天后再次刷新')
          $('.reflesh-time').css('display','block').siblings('div.reflesh-job')
                                                   .css('display','none');
        },
        error: function(){
          alert('刷新失败');
        },
      });
    })
  </script>

  <section class="job-right">
    <div class="job-descripte">
      <h2>职位描述</h2>
      <h3>职责说明</h3>
      <p><%= @job.job_desc %></p>
      <h3 class="job-post">任职资格</h3>
      <p><%= @job.job_demand %></p>
    </div>
  </section>

</div>

  <div class="btn-bottom-box">
    <div class="pause-box btn-bottom">
      <div id="postPause" class="<%= @job_sate[:status] %>" onclick="postPause(this)">
        <span><%= @btn_txt[:pause] %></span>
      </div>
    </div>

    <div class="release-box btn-bottom">
      <div id="release" class="<%= @job_sate[:status] %>" onclick="release(this)">
        <span><%= @btn_txt[:release] %></span>
      </div>
    </div>

    <div class="end-box btn-bottom">
      <div id="end" class="<%= @job_sate[:status] %>" onclick="end(this)">
        <span><%= @btn_txt[:end] %></span>
      </div>
    </div>
  </div>


<script type="text/javascript">

  var popup = function(li_text, call_fun){
    var len = $("body>div#popup").length;
    if(len == 0) {
      $('body').append('<div id="popup"><ul><li id="li_1">'+li_text+
                   '</li><li id="li_2" onclick="'+call_fun+'">确定</li><li id="li_3" onclick="Clickfail(this)">取消</li></ul></div>');
    };
  };

  function Clickfail(){
    $("#popup").remove();
  }

  // 暂停按钮
  function postPause(obj) {
      if($(obj).attr("class") == "release") {
        popup('确定暂停发布此职位？', "pause_job()");
      } else {
        console.log("当前无法暂停");
      }
  }

  // 暂停发布职位
  function pause_job() {
    $("#popup").remove();
    $.ajax({
      url: '<%= api_employer_jobs_path %>',
      type: 'PATCH',
      data: {"job_id":"<%= @job[:id] %>", "status": "pause"},
      success: function() {
        set_class('pause');
        $('#release span').text("再次发布");
        $('#postPause').off();
      },
      error: function() {
        alert('暂停失败。');
      },
    });
  }

  // 再次发布按钮
  function release(obj) {
    // 当值为再次发布时点击判断may_release
    var vip_status = "<%= @vip_status['may_release'] %>"
    var button_text = $(obj).text();

    if(button_text == '再次发布' && vip_status == 'false') {
      alert('您的可发布职位数已满，若想发布更多，请购买VIP');
      return;
    }
      // 当值为再次发布时点击判断may_release
      if(["pause", "end", "saved", "fail"].indexOf($(obj).attr("class")) != -1 ) {
        popup('确定发布此职位？', "again_release()");
      } else {
        console.log("当前无法执行此操作");
      }
  }

  // 再次发布
  function again_release() {
    var status = '',
        btn_txt = '',
        btn_class = '',
        duration = ''
    $("#popup").remove();
    if($("#release").attr("class") == 'pause') {
       status = 'release'
       btn_txt = "已经发布"
       btn_class = 'release'
    } else if($("#release").attr("class") == 'end') {
      status = 'release_again'
      btn_txt = "已经发布"
      btn_class = 'release'
      duration = "<%= @job[:duration] %>"
    } else {
      status = 'reviewing'
      btn_txt = "等待审核"
      btn_class = 'reviewing'
    }

    $.ajax({
      url: '<%= api_employer_jobs_path %>',
      type: 'PATCH',
      data: {"job_id":"<%= @job[:id] %>", "status": status, "duration": duration},
      success: function() {
        $('#release span').text(btn_txt);
        set_class(btn_class);
        $('#release').off();
      },
      error: function() {
        alert('操作失败。');
      },
    });
  }

  // 结束发布按钮
  function end(obj) {
      if(["release", "pause"].indexOf($(obj).attr("class")) != -1 ) {
        popup('确定结束发布此职位？', "end_true()");
      } else if(["saved", "fail"].indexOf($(obj).attr("class")) != -1) {
        popup('确定删除此职位？', "delete_job()");
      } else {
        console.log("当前无法执行此操作");
      }
  }

  // 判断为　true 后结束发布
  function end_true() {
    $("#popup").remove();
    $.ajax({
      url: '<%= api_employer_jobs_path %>',
      type: 'PATCH',
      data: {"job_id":"<%= @job[:id] %>", "status": "end"},
      success: function() {
        $('#release span').text("再次发布")
        set_class('end');
        $('#end').off();
      },
      error: function() {
        alert('结束发布失败。')
      },
    });
  }

  //删除　发布职位
  function delete_job() {
    $("#popup").remove();
    $.ajax({
      url: '<%= api_employer_jobs_path %>',
      type: 'DELETE',
      data: {id: "<%= @job[:id] %>"},
      success: function() {
        console.log('删除成功！');
      },
      error: function() {
        alert('删除失败。')
      },
    });
  }

  // 同时设置三个按钮状态
  function set_class(name) {
      $('#end').attr('class', name);
      $('#release').attr('class', name);
      $('#postPause').attr('class', name);
  }

</script>
