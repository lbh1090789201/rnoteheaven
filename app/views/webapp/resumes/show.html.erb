<% provide :title, "我的简历" %>
<% provide :link, "#{current_user.id}/preview" %>
<%= provide :content, "预览" %>
<div class="container resume-show">
    <div class="wrap">

        <section class="show-style">
            <h2>设置头像</h2>
            <div class="box box-avatar">
                <div class="avatar">
                    <%= image_tag "pencil.png", class: "pencil" %>
                    <div class="avatar-img">
                      <div class="avatar-box" style="background-img:url(<%= @avatar %>)">
                          <!-- 待修改样式 bobo -->
                      </div>
                      <%= image_tag @avatar %>
                     </div>
                     <%= simple_form_for @user, method: :patch, url: webapp_user_path(params[:id]),remote: true do |f| %>
                         <%= f.input :avatar, label: '头像', input_html: {id:"avatar"} %>
                         <%= f.button :submit %>
                     <% end %>
                    <span>点击更换</span>
                </div>
            </div>
        </section>

        <script>
        function setImagePreview(){
        var docObj=document.getElementById("file_img");
        var text = innerHTML=window.URL.createObjectURL(docObj.files[0]);
        var img = document.createElement("img");
        img.setAttribute("src", text);
        img.setAttribute("width", "170px");
        img.setAttribute("height", "170px");
        $(".avatar-img").html(img);
    }
        </script>


        <%# @user.each do |u| %>
        <section class="show-style">
            <h2>基本信息
            </h2>
            <div class="box">
                <table>
                    <tr>
                        <td><span>姓</span>名：</td>
                        <td><%= @user.show_name %></td>
                    </tr>
                    <tr>
                        <td><span>性</span>别：</td>
                        <td><%= @user.sex %></td>
                    </tr>
                    <tr>
                        <td>最高学历：</td>
                        <td><%= @user.highest_degree %></td>
                    </tr>
                    <tr>
                        <td><span>职</span>称：</td>
                        <td><%= @user.position %></td>
                    </tr>
                    <tr>
                        <td>工作年限：</td>
                        <td><%= @user.start_work_at %></td>
                    </tr>
                    <tr>
                        <td>出生年限：</td>
                        <td><%= @user.birthday %></td>
                    </tr>
                    <tr>
                        <td>所在城市：</td>
                        <td><%= @user.location %></td>
                    </tr>
                    <tr>
                        <td>联系电话：</td>
                        <td><%= @user.cellphone %></td>
                    </tr>
                    <tr>
                        <td>联系邮箱：</td>
                        <td><%= @user.email %></td>
                    </tr>
                    <tr>
                        <td>当前状态：</td>
                        <td></td>
                    </tr>

                </table>
            </div>
        </section>
        <%# end %>


        <section class="show-style">
            <h2>工作经历<span>必填</span>
            </h2>
            <% if !@work_experiences.blank? %>
            <div class="box work-show">
                <a href="<%= webapp_work_experiences_path %>" class="edit">
                    <%= image_tag "pencil3.png" %>编辑
                </a>
               <% @work_experiences.each do |w| %>
                <time><%= w.started_at.strftime("%Y-%m-%d") if w.started_at %>-<%= w.left_time.strftime("%Y-%m-%d") if w.left_time %></time>
                <div class="time-line-box">
                    <h3><%= w.company %><a class="expend" onclick="expend_desc(this)">
                            展开<%= image_tag "down2.png" %>
                        </a>
                    </h3>
                    <p class="job-desc-show">
                      <%= w.job_desc[0, 60] + '……' %>
                    </p>
                     <p class="job-desc-hide" style="display:none;">
                       <%= w.job_desc %>
                     </p>
                </div>
              <% end %>
            </div>
            <% else %>
               <div class="edit-blank">
                 <a href="<%= new_webapp_work_experience_path %>">
                   <p>
                       <%= image_tag "ti"%>
                       <span>添加工作经历</span>
                  </p>
                 </a>
               </div>
            <% end %>
        </section>


        <section class="show-style">
            <h2>教育经历<span>必填</span>
            </h2>
            <% if !@education_experiences.blank? %>
            <div class="box work-show">
                <% @education_experiences.each do |e| %>
                <time><%= e.graduated_at.strftime("%Y") if e.graduated_at %>年毕业</time>
                <div class="time-line-box">
                  <a href="<%= webapp_education_experiences_path %>" class="edit">
                      <%= image_tag "pencil3.png" %>编辑
                  </a>
                    <h3><%= e.college %>
                    </h3>
                  <p><%= e.major %></p>
                </div>
              <% end %>
            </div>
            <% else %>
               <div class="edit-blank">
                 <a href="<%= new_webapp_education_experience_path %>">
                   <p>
                       <%= image_tag "ti"%>
                       <span>添加教育经历</span>
                  </p>
                 </a>
               </div>
            <% end %>
        </section>

          <section class="show-style">
              <h2>持有证书
              </h2>
              <div class="box work-show">
                  <a href="/webapp/certificates" class="edit">
                      <%= image_tag "pencil3.png" %>编辑
                  </a>
                  <h3>持有证书</h3>
                  <p>
                    中国医师协会奖
                  </p>
              </div>
          </section>

        <section class="show-style">
            <h2>期望工作<span>必填</span>
            </h2>
            <% if @expect_job %>
            <div class="box work-show">
                <a href="<%= edit_webapp_expect_job_path(@expect_job.id) %>" class="edit">
                    <%= image_tag "pencil3.png" %>编辑
                </a>
                <h3><%= @expect_job.name %></h3>
                <p>
                  <%= @expect_job.job_type %>/<%= @expect_job.location %>/<%= @expect_job.expected_salary_range %>
                </p>
            </div>
            <% end %>
        </section>


        <button type="button" name="button" class="refresh">刷新简历</button>
    </div>
</div>

<script type="text/javascript">
function expend_desc(obj) {
    console.log();
    $(obj).parent().siblings('.job-desc-show').toggle(300);
    $(obj).parent().siblings('.job-desc-hide').toggle(300);

};

// 点击上传头像
$($('#avatar').change(function() {
  $('input[type=submit]').click();
}));

$($('.avatar-img').click(function() {
  $('#avatar').click();
}));


$('#edit_user_1').bind('ajax:success', function(){
  alert('ok');
  history.go(0);
});

// 刷新简历
$('.refresh').click(function() {
  $.ajax({
    url: '<%= webapp_resume_path(params[:id]) %>',
    type: 'PATCH',
    data: {refresh: true},
    success: function() {
      $('.refresh').html('下次刷新剩余7天');
      $('.refresh').css('background-color', 'gray');
      $('.refresh').off();
    },
    error: function() {
      alert('刷新失败。')
    }
  });
});

// 判断剩余写几天
<% if @refresh_left  %>
  $(function() {
    $('.refresh').html('<%= @refresh_left %>天后可再次刷新');
    $('.refresh').css('background-color', 'gray');
    $('.refresh').off();
  });
<% end %>

</script>
